#!/bin/bash
# Voice Assistant Control Script

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

SERVICE_NAME="voice-assistant.service"

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

show_status() {
    echo "ðŸŽ¤ Voice Assistant Status"
    echo "========================"
    
    # Service status
    if systemctl --user is-active "$SERVICE_NAME" &>/dev/null; then
        echo -e "Service: ${GREEN}ACTIVE${NC}"
    else
        echo -e "Service: ${RED}INACTIVE${NC}"
    fi
    
    # Process status
    if pgrep -f voice-assistant &>/dev/null; then
        PID=$(pgrep -f voice-assistant)
        echo -e "Process: ${GREEN}RUNNING${NC} (PID: $PID)"
    else
        echo -e "Process: ${RED}NOT RUNNING${NC}"
    fi
    
    # Claude Code status
    if command -v claude &>/dev/null; then
        CLAUDE_VER=$(claude --version 2>/dev/null)
        echo -e "Claude Code: ${GREEN}$CLAUDE_VER${NC}"
    else
        echo -e "Claude Code: ${RED}NOT FOUND${NC}"
    fi

    # Session info
    SESSION_FILE="$HOME/.local/state/voice-assistant/session_id"
    if [[ -f "$SESSION_FILE" ]] && [[ -s "$SESSION_FILE" ]]; then
        SID=$(cat "$SESSION_FILE")
        echo -e "Session: ${GREEN}${SID:0:12}...${NC} (continuing)"
    else
        echo -e "Session: ${YELLOW}NONE${NC} (will start new)"
    fi

    # Log file
    LOG_FILE="$HOME/.local/state/voice-assistant/voice-assistant.log"
    if [[ -f "$LOG_FILE" ]]; then
        SIZE=$(du -h "$LOG_FILE" | cut -f1)
        echo -e "Log file: ${GREEN}$SIZE${NC} ($LOG_FILE)"
    else
        echo -e "Log file: ${YELLOW}NOT FOUND${NC}"
    fi
}

start_service() {
    log_info "Starting voice assistant..."
    systemctl --user start "$SERVICE_NAME"
    sleep 2
    if systemctl --user is-active "$SERVICE_NAME" &>/dev/null; then
        log_success "Voice assistant started"
    else
        log_error "Failed to start voice assistant"
        exit 1
    fi
}

stop_service() {
    log_info "Stopping voice assistant..."
    systemctl --user stop "$SERVICE_NAME"
    log_success "Voice assistant stopped"
}

restart_service() {
    log_info "Restarting voice assistant..."
    systemctl --user restart "$SERVICE_NAME"
    sleep 2
    if systemctl --user is-active "$SERVICE_NAME" &>/dev/null; then
        log_success "Voice assistant restarted"
    else
        log_error "Failed to restart voice assistant"
        exit 1
    fi
}

PID_FILE="$HOME/.local/state/voice-assistant/voice-assistant.pid"

_send_signal() {
    local sig="$1"
    if [[ -f "$PID_FILE" ]]; then
        local pid
        pid=$(cat "$PID_FILE")
        if kill -0 "$pid" 2>/dev/null; then
            kill -"$sig" "$pid"
            return 0
        fi
    fi
    return 1
}

toggle_voice() {
    if _send_signal USR1; then
        log_info "Toggling voice mode..."
        log_success "Voice mode toggled"
    else
        log_error "Voice assistant is not running"
        exit 1
    fi
}

new_session() {
    if _send_signal USR2; then
        log_info "Starting new conversation..."
        log_success "New conversation will begin on next query"
    else
        log_warning "Voice assistant is not running, clearing persisted session..."
        rm -f "$HOME/.local/state/voice-assistant/session_id"
        log_success "Session cleared"
    fi
}

show_logs() {
    local lines=${1:-50}
    log_info "Showing last $lines lines of logs..."
    
    if [[ "$2" == "-f" ]]; then
        journalctl --user -u "$SERVICE_NAME" -n "$lines" -f
    else
        journalctl --user -u "$SERVICE_NAME" -n "$lines"
    fi
}

show_help() {
    echo "Voice Assistant Control Script"
    echo "=============================="
    echo
    echo "Usage: $0 <command>"
    echo
    echo "Commands:"
    echo "  status      Show service status and info"
    echo "  start       Start the voice assistant service"
    echo "  stop        Stop the voice assistant service"
    echo "  restart     Restart the voice assistant service"
    echo "  toggle      Toggle voice mode on/off (same as SUPER key)"
    echo "  new-session Start a new conversation (clear session)"
    echo "  logs [N]    Show last N lines of logs (default: 50)"
    echo "  logs -f     Follow logs in real-time"
    echo "  test        Run installation tests"
    echo "  help        Show this help message"
    echo
    echo "Examples:"
    echo "  $0 status       # Check if running"
    echo "  $0 start        # Start the service"
    echo "  $0 toggle       # Toggle voice mode"
    echo "  $0 logs 100     # Show last 100 log lines"
    echo "  $0 logs -f      # Follow logs in real-time"
}

run_test() {
    if [[ -f "test_installation.py" ]]; then
        log_info "Running installation tests..."
        ./test_installation.py
    else
        log_error "Test script not found. Please run from the voice-assistant directory."
        exit 1
    fi
}

# Main command handling
case "${1:-}" in
    "status"|"stat")
        show_status
        ;;
    "start")
        start_service
        ;;
    "stop")
        stop_service
        ;;
    "restart"|"reload")
        restart_service
        ;;
    "toggle")
        toggle_voice
        ;;
    "new-session"|"new"|"reset")
        new_session
        ;;
    "logs"|"log")
        if [[ "$2" == "-f" ]]; then
            show_logs 50 -f
        else
            show_logs "${2:-50}"
        fi
        ;;
    "test")
        run_test
        ;;
    "help"|"-h"|"--help")
        show_help
        ;;
    *)
        log_error "Unknown command: ${1:-}"
        echo
        show_help
        exit 1
        ;;
esac